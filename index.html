<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CANVA OTP</title>
    <link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>✨</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .new-item, .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes newOtpHighlight { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        .new-otp-item { animation: newOtpHighlight 0.8s ease-in-out; }

        #progress-bar { transition: width 1s linear; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-gray-900 text-slate-800 dark:text-gray-200 transition-colors duration-300">

    <!-- Layar Login -->
    <div id="login-screen" class="w-full h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-sm mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white">
                    <span class="bg-gradient-to-r from-purple-500 to-pink-500 text-transparent bg-clip-text">Canva OTP Akses Terproteksi</span>
                </h1>
                <p class="text-slate-500 dark:text-gray-400 mt-2">Masukkan kata sandi untuk melanjutkan</p>
            </header>
            <form id="login-form" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="mb-4">
                    <label for="password-input" class="block text-sm font-medium text-slate-600 dark:text-gray-300 mb-2">Kata Sandi</label>
                    <input type="password" id="password-input" class="w-full bg-slate-100 dark:bg-gray-700 border-slate-300 dark:border-gray-600 text-slate-900 dark:text-white rounded-lg p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <p id="error-message" class="text-red-500 text-sm mb-4 h-5"></p>
                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Masuk</button>
            </form>
        </div>
    </div>

    <!-- Aplikasi Utama (Tersembunyi) -->
    <div id="app-screen" class="hidden">
        <button id="theme-toggle" class="fixed top-4 right-4 p-2 rounded-full bg-slate-200 dark:bg-gray-700 text-slate-600 dark:text-gray-300 hover:bg-slate-300 dark:hover:bg-gray-600 transition-all duration-300 z-10"></button>
        <div class="w-full max-w-lg mx-auto pt-16 pb-4 px-4">
            <header class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-bold text-slate-900 dark:text-white">
                    <span class="bg-gradient-to-r from-purple-500 to-pink-500 text-transparent bg-clip-text">CANVA OTP</span>
                </h1>
                <p class="text-slate-500 dark:text-gray-400 mt-2">Premium Canva OTP Fetcher by AS</p>
            </header>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-8 transition-colors duration-300">
                <div class="mb-4">
                    <label for="email-input" class="block text-sm font-medium text-slate-600 dark:text-gray-300 mb-2">Email</label>
                    <input type="text" id="email-input" class="w-full bg-slate-100 dark:bg-gray-700 border-slate-300 dark:border-gray-600 text-slate-900 dark:text-white rounded-lg p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Generate atau masukkan satu email..."/>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button id="generate-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Generate</button>
                    <button id="copy-email-btn" class="w-full bg-slate-500 hover:bg-slate-600 dark:bg-gray-600 dark:hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Copy Email</button>
                    <button id="toggle-monitor-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Cek OTP</button>
                    <button id="clear-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Bersihkan</button>
                </div>
                <div class="w-full bg-slate-200 dark:bg-gray-700 rounded-full h-2.5 mt-4 overflow-hidden hidden" id="progress-container">
                    <div id="progress-bar" class="bg-purple-500 h-2.5 rounded-full" style="width: 100%"></div>
                </div>
            </div>
            <div id="status-container" class="text-center mb-4 h-6"></div>
            <div id="results-container"></div>
        </div>
    </div>

    <script>
        // --- Konfigurasi ---
        const CORRECT_PASSWORD = "asproject"; // GANTI DENGAN KATA SANDI ANDA
        const POLLING_INTERVAL = 2000;
        const MONITORING_DURATION = 20000;
        const API_BASE_URL = "https://mailgo.site/api/messages";

        // --- Variabel Global ---
        let pollingInterval, stopTimeout, countdownInterval, usedMessageIds = {};
        let synth;

        // --- Elemen DOM ---
        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('password-input');
        const errorMessage = document.getElementById('error-message');
        
        const themeToggleBtn = document.getElementById('theme-toggle');
        const generateBtn = document.getElementById('generate-btn');
        const copyEmailBtn = document.getElementById('copy-email-btn');
        const toggleBtn = document.getElementById('toggle-monitor-btn');
        const clearBtn = document.getElementById('clear-btn');
        const emailInput = document.getElementById('email-input');
        const resultsContainer = document.getElementById('results-container');
        const statusContainer = document.getElementById('status-container');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const favicon = document.getElementById('favicon');

        // --- Logika Proteksi & Login ---
        function showApp() {
            loginScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
            appScreen.classList.add('fade-in');
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (passwordInput.value === CORRECT_PASSWORD) {
                sessionStorage.setItem('isVerified', 'true');
                showApp();
            } else {
                errorMessage.textContent = 'Kata sandi salah. Silakan coba lagi.';
                passwordInput.value = '';
                passwordInput.focus();
            }
        });
        
        // Cek saat halaman dimuat
        if (sessionStorage.getItem('isVerified') === 'true') {
            showApp();
        }

        // --- Logika Tema ---
        const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 14.95l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 001.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z" clip-rule="evenodd" /></svg>`;
        const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg>`;
        const applyTheme = (isDark) => {
            document.documentElement.classList.toggle('dark', isDark);
            themeToggleBtn.innerHTML = isDark ? sunIcon : moonIcon;
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        };
        themeToggleBtn.addEventListener('click', () => applyTheme(!document.documentElement.classList.contains('dark')));
        applyTheme(localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches));

        // --- Notifikasi Suara & Favicon ---
        const playNotificationSound = () => {
            if (!synth) synth = new Tone.Synth().toDestination();
            Tone.start();
            synth.triggerAttackRelease("C5", "8n");
        };

        const setFavicon = (status) => {
            const emoji = { idle: '✨', loading: '⏳', found: '✅' }[status] || '✨';
            favicon.href = `data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>${emoji}</text></svg>`;
        };
        
        // --- Fungsi Inti Aplikasi ---
        function generateReadableEmail() {
            const vowels = 'aeiou', consonants = 'bcdfghjklmnpqrstvwxyz';
            let username = '', length = Math.floor(Math.random() * 2) + 6, useVowel = Math.random() > 0.5;
            for (let i = 0; i < length; i++) {
                username += useVowel ? vowels.charAt(Math.floor(Math.random() * vowels.length)) : consonants.charAt(Math.floor(Math.random() * consonants.length));
                useVowel = !useVowel;
            }
            return `${username}@kanvapro.site`;
        }

        async function pollInbox(email) {
            try {
                const response = await fetch(`${API_BASE_URL}/${email}/aurigo`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const messages = await response.json();
                messages.reverse();

                for (const msg of messages) {
                    const isFromCanva = msg.from?.toLowerCase().includes("canva") || msg.subject?.toLowerCase().includes("canva");
                    const isNewMessage = !usedMessageIds[email].has(msg.id);

                    if (isFromCanva && isNewMessage) {
                        usedMessageIds[email].add(msg.id);
                        let otpMatches = msg.content?.match(/\b\d{6}\b/g);
                        let foundOtps = otpMatches ? [...new Set(otpMatches)].filter(otp => otp !== '000000') : [];
                        
                        const card = document.getElementById(`card-${email.replace(/[@.]/g, '-')}`);
                        if (card) {
                            const existingOtps = JSON.parse(card.dataset.otps || '[]');
                            const trulyNewOtps = foundOtps.filter(otp => !existingOtps.includes(otp));
                            if (trulyNewOtps.length > 0) {
                                const combinedOtps = [...new Set([...trulyNewOtps, ...existingOtps])];
                                card.dataset.otps = JSON.stringify(combinedOtps);
                                updateCardWithOTP(email, combinedOtps, msg.subject, trulyNewOtps);
                                playNotificationSound();
                                setFavicon('found');
                            } else {
                                updateCardWithOTP(email, existingOtps, msg.subject, []);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error(`[${email}] Error polling:`, error);
                updateCardStatus(email, 'error');
            }
        }

        function startMonitoring() {
            const email = emailInput.value.trim();
            if (!email) {
                showStatus("⚠️ Masukkan email terlebih dahulu.", 'yellow', 3000);
                return;
            }

            resultsContainer.innerHTML = '';
            usedMessageIds = { [email]: new Set() };
            createResultCard(email);
            setFavicon('loading');

            pollInbox(email); 
            pollingInterval = setInterval(() => pollInbox(email), POLLING_INTERVAL);
            stopTimeout = setTimeout(stopMonitoring, MONITORING_DURATION);

            progressContainer.classList.remove('hidden');
            progressBar.style.width = '100%';
            setTimeout(() => { progressBar.style.width = '0%'; progressBar.style.transition = `width ${MONITORING_DURATION / 1000}s linear`; }, 100);

            let countdown = MONITORING_DURATION / 1000;
            showStatus(`📡 Memantau... sisa ${countdown} detik`, 'green');
            countdownInterval = setInterval(() => {
                countdown--;
                if (countdown >= 0) showStatus(`📡 Memantau... sisa ${countdown} detik`, 'green');
            }, 1000);

            toggleBtn.textContent = 'Hentikan';
            toggleBtn.classList.replace('bg-purple-600', 'bg-yellow-600');
            toggleBtn.classList.replace('hover:bg-purple-700', 'hover:bg-yellow-700');
            [emailInput, generateBtn, copyEmailBtn, clearBtn].forEach(el => el.disabled = true);
        }

        function stopMonitoring() {
            if (pollingInterval) clearInterval(pollingInterval);
            if (stopTimeout) clearTimeout(stopTimeout);
            if (countdownInterval) clearInterval(countdownInterval);
            pollingInterval = stopTimeout = countdownInterval = null;

            if (document.querySelector('[data-has-result="true"]')) {
                setFavicon('found');
            } else {
                setFavicon('idle');
            }
            
            showStatus("⏹️ Pemantauan selesai.", 'gray', 5000);
            progressContainer.classList.add('hidden');
            toggleBtn.textContent = 'Cek OTP';
            toggleBtn.classList.replace('bg-yellow-600', 'bg-purple-600');
            toggleBtn.classList.replace('hover:bg-yellow-700', 'hover:bg-purple-700');
            [emailInput, generateBtn, copyEmailBtn, clearBtn].forEach(el => el.disabled = false);
        }

        function createResultCard(email) {
            const card = document.createElement('div');
            card.id = `card-${email.replace(/[@.]/g, '-')}`;
            card.dataset.otps = '[]';
            card.className = 'bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg new-item transition-colors duration-300';
            card.innerHTML = `<div class="flex justify-between items-center mb-4"><p class="text-lg font-medium text-purple-500 dark:text-purple-400 truncate w-4/5" title="${email}">${email}</p><span id="status-${email.replace(/[@.]/g, '-')}" class="text-sm font-semibold text-slate-400 dark:text-gray-400 animate-pulse">Menunggu...</span></div><div id="otp-display-${email.replace(/[@.]/g, '-')}" class="bg-slate-100 dark:bg-gray-900 rounded-lg p-4 text-center min-h-[90px] flex flex-col justify-center transition-colors duration-300"><p class="text-sm text-slate-500 dark:text-gray-500 mb-1">OTP DARI CANVA</p><p class="text-3xl font-bold text-slate-400 dark:text-gray-500 tracking-widest leading-tight">- - - - - -</p></div><div id="copy-container-${email.replace(/[@.]/g, '-')}" class="mt-4"></div>`;
            resultsContainer.appendChild(card);
        }
        
        function updateCardWithOTP(email, allOtps, subject, newOtps = []) {
            const cardId = `card-${email.replace(/[@.]/g, '-')}`;
            const card = document.getElementById(cardId);
            if (!card) return;

            const otpDisplayEl = document.getElementById(`otp-display-${email.replace(/[@.]/g, '-')}`);
            const statusEl = document.getElementById(`status-${email.replace(/[@.]/g, '-')}`);
            const copyContainerEl = document.getElementById(`copy-container-${email.replace(/[@.]/g, '-')}`);

            if (allOtps && allOtps.length > 0) {
                const newestOtp = allOtps[0];
                const otpHtml = allOtps.map(otp => {
                    const isNew = newOtps.includes(otp);
                    const colorClass = isNew ? 'text-yellow-500 dark:text-yellow-400' : 'text-green-600 dark:text-green-400';
                    return `<span class="relative inline-block px-2 ${isNew ? 'new-otp-item' : ''} font-bold ${colorClass}">${otp}</span>`;
                }).join('<span class="mx-1 text-slate-400 dark:text-gray-600">|</span>');
                
                otpDisplayEl.innerHTML = `<p class="text-sm text-slate-500 dark:text-gray-500 mb-1">OTP DARI CANVA</p><p class="text-3xl font-bold tracking-normal leading-tight">${otpHtml}</p>`;
                copyContainerEl.innerHTML = `<button onclick="copyToClipboard('${newestOtp}', this)" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Copy OTP Terbaru (${newestOtp})</button>`;
                statusEl.textContent = 'Ditemukan!';
                statusEl.className = 'text-sm font-semibold text-green-600 dark:text-green-400';
            } else {
                if (!card.dataset.hasResult) {
                    otpDisplayEl.innerHTML = `<p class="text-sm text-slate-500 dark:text-gray-500 mb-1">OTP DARI CANVA</p><p class="text-3xl font-bold text-red-500 dark:text-red-400 tracking-normal leading-tight">Tidak Ditemukan</p>`;
                    statusEl.textContent = 'Tidak ada OTP';
                    statusEl.className = 'text-sm font-semibold text-red-500 dark:text-red-400';
                }
            }
            if (allOtps.length > 0) card.dataset.hasResult = "true";
            statusEl.classList.remove('animate-pulse');
        }

        function updateCardStatus(email, statusType) {
            const statusEl = document.getElementById(`status-${email.replace(/[@.]/g, '-')}`);
            if (statusEl && statusType === 'error') {
                statusEl.textContent = 'Error';
                statusEl.className = 'text-sm font-semibold text-red-500 dark:text-red-400';
                statusEl.classList.remove('animate-pulse');
            }
        }
        
        function showStatus(message, color, duration = 0) {
            const colorClasses = {
                green: 'text-green-600 dark:text-green-400',
                yellow: 'text-yellow-500 dark:text-yellow-400',
                red: 'text-red-500 dark:text-red-400',
                blue: 'text-blue-500 dark:text-blue-400',
                gray: 'text-slate-500 dark:text-gray-400'
            };
            statusContainer.textContent = message;
            statusContainer.className = `text-center mb-4 h-6 ${colorClasses[color] || 'text-slate-500 dark:text-gray-400'}`;
            if (duration > 0) setTimeout(() => { if (statusContainer.textContent === message) statusContainer.textContent = ''; }, duration);
        }

        function copyToClipboard(text, buttonElement) {
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            if (buttonElement) {
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = 'Tersalin!';
                setTimeout(() => { buttonElement.innerHTML = originalText; }, 2000);
            }
        }

        // --- Event Listeners Aplikasi Utama ---
        toggleBtn.addEventListener('click', () => { if (pollingInterval) stopMonitoring(); else startMonitoring(); });
        clearBtn.addEventListener('click', () => {
            if (pollingInterval) stopMonitoring();
            resultsContainer.innerHTML = '';
            emailInput.value = '';
            showStatus("🧹 Hasil & email dibersihkan.", 'gray', 3000);
            setFavicon('idle');
        });
        generateBtn.addEventListener('click', () => {
            emailInput.value = generateReadableEmail();
            showStatus(`📧 Email baru digenerate: ${emailInput.value}`, 'blue', 4000);
        });
        copyEmailBtn.addEventListener('click', () => {
            const emailToCopy = emailInput.value;
            if (!emailToCopy) {
                showStatus("⚠️ Tidak ada email untuk disalin.", 'yellow', 3000);
                return;
            }
            copyToClipboard(emailToCopy);
            showStatus("✅ Email berhasil disalin ke clipboard!", 'green', 3000);
        });
    </script>
</body>
</html>
